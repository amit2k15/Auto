from pyzabbix import ZabbixAPI
from collections import defaultdict
import openpyxl

# Zabbix credentials
ZABBIX_URL = 'https://your-zabbix-url.com/zabbix'
ZABBIX_USER = 'your-username'
ZABBIX_PASS = 'your-password'

# Connect to Zabbix
zapi = ZabbixAPI(ZABBIX_URL)
zapi.login(ZABBIX_USER, ZABBIX_PASS)

# Dictionary to hold triggers mapped to hosts
trigger_host_map = defaultdict(list)

# Get all triggers with associated hosts
triggers = zapi.trigger.get(
    output=["triggerid", "description"],
    selectHosts=["host"],
    filter={"value": 0},  # only problem triggers if you want; remove this line to get all
    expandDescription=True
)

# Group triggers by description
for trig in triggers:
    desc = trig['description']
    hosts = [host['host'] for host in trig['hosts']]
    trigger_host_map[desc].extend(hosts)

# Filter triggers that are configured on more than one host
common_triggers = {k: v for k, v in trigger_host_map.items() if len(set(v)) > 1}

# Write to Excel
wb = openpyxl.Workbook()
ws = wb.active
ws.title = "Common Triggers"
ws.append(["Trigger Name", "Hostnames"])

for trigger_name, hosts in common_triggers.items():
    ws.append([trigger_name, ', '.join(sorted(set(hosts)))])

output_file = "common_triggers.xlsx"
wb.save(output_file)
print(f"Saved to {output_file}")
