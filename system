from pyzabbix import ZabbixAPI
import pandas as pd

# Zabbix credentials
ZABBIX_URL = 'http://your-zabbix-url/zabbix'
USERNAME = 'your-username'
PASSWORD = 'your-password'

# Connect to Zabbix API
zapi = ZabbixAPI(ZABBIX_URL)
zapi.login(USERNAME, PASSWORD)

# Step 1: Get all items with keys starting with system.run
items = zapi.item.get(
    search={'key_': 'system.run'},
    searchWildcardsEnabled=True,
    output=['itemid', 'name', 'key_', 'status', 'hostid']
)

# Step 2: Get unique host IDs from items
host_ids = list({item['hostid'] for item in items})

# Step 3: Get host details
hosts = zapi.host.get(
    hostids=host_ids,
    output=['host', 'status'],
    selectGroups=['name']
)

# Build a lookup table for hosts
host_map = {}
for host in hosts:
    group_names = [group['name'] for group in host.get('groups', [])]
    host_map[host['hostid']] = {
        'host': host['host'],
        'status': 'Enabled' if host['status'] == '0' else 'Disabled',
        'groups': group_names
    }

# Step 4: Combine data
data = []
for item in items:
    host_info = host_map.get(item['hostid'], {})
    for group in host_info.get('groups', ['']):
        data.append({
            'Host Name': host_info.get('host', ''),
            'Host Status': host_info.get('status', ''),
            'Item Name': item.get('name', ''),
            'Item Key': item.get('key_', ''),
            'Item Status': 'Enabled' if item.get('status') == '0' else 'Disabled',
            'Group Name': group
        })

# Step 5: Export to Excel
df = pd.DataFrame(data)
df.to_excel('zabbix_system_run_items.xlsx', index=False)

print("Excel file 'zabbix_system_run_items.xlsx' has been created successfully.")
