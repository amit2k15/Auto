import pandas as pd
from pyzabbix import ZabbixAPI
from openpyxl import Workbook
from datetime import datetime

# Zabbix API credentials
ZABBIX_SERVER = 'http://your-zabbix-server/zabbix'
ZABBIX_USER = 'your-username'
ZABBIX_PASSWORD = 'your-password'

def get_zabbix_data():
    # Connect to Zabbix API
    zapi = ZabbixAPI(ZABBIX_SERVER)
    zapi.login(ZABBIX_USER, ZABBIX_PASSWORD)
    print(f"Connected to Zabbix API Version {zapi.api_version()}")

    # Get all hosts with their groups and items
    hosts = zapi.host.get(
        output=['hostid', 'host', 'name', 'status'],
        selectGroups=['name'],
        selectItems=['itemid', 'name', 'key_', 'status'],
        filter={'key_': ['system.run[']},  # Filter for items starting with system.run
        search={'key_': 'system.run'},
        searchWildcardsEnabled=True
    )

    data = []
    
    for host in hosts:
        host_name = host['host']
        host_status = 'Enabled' if host['status'] == '0' else 'Disabled'
        
        # Get group names
        group_names = [group['name'] for group in host.get('groups', [])]
        groups = ', '.join(group_names)
        
        # Process items
        for item in host.get('items', []):
            if item['key_'].startswith('system.run'):
                item_name = item['name']
                item_key = item['key_']
                item_status = 'Enabled' if item['status'] == '0' else 'Disabled'
                
                data.append({
                    'Host Name': host_name,
                    'Host Status': host_status,
                    'Group Name': groups,
                    'Item Name': item_name,
                    'Item Key': item_key,
                    'Item Status': item_status
                })

    # Create DataFrame
    df = pd.DataFrame(data)
    
    # Disconnect from Zabbix API
    zapi.user.logout()
    
    return df

def export_to_excel(dataframe):
    # Generate filename with timestamp
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    filename = f"zabbix_system_run_items_{timestamp}.xlsx"
    
    # Export to Excel
    dataframe.to_excel(filename, index=False, engine='openpyxl')
    print(f"Data exported to {filename}")

if __name__ == "__main__":
    try:
        # Get data from Zabbix
        zabbix_data = get_zabbix_data()
        
        if not zabbix_data.empty:
            # Export to Excel
            export_to_excel(zabbix_data)
        else:
            print("No items found starting with 'system.run'")
    except Exception as e:
        print(f"An error occurred: {str(e)}")
