from pyzabbix import ZabbixAPI
import pandas as pd

# Zabbix credentials and URL
ZABBIX_URL = 'http://your-zabbix-url/zabbix'
USERNAME = 'your-username'
PASSWORD = 'your-password'

# Connect to Zabbix API
zapi = ZabbixAPI(ZABBIX_URL)
zapi.login(USERNAME, PASSWORD)

# Fetch all items with keys starting with "system.run"
items = zapi.item.get(
    search={'key_': 'system.run'},
    searchWildcardsEnabled=True,
    output=['itemid', 'name', 'key_', 'status', 'hostid'],
    selectHosts=['hostid', 'host', 'status'],
    selectGroups=['name']
)

# Prepare data for export
data = []
for item in items:
    host = item['hosts'][0] if item['hosts'] else {}
    groups = item['groups']

    for group in groups:
        data.append({
            'Host Name': host.get('host', ''),
            'Host Status': 'Enabled' if host.get('status') == '0' else 'Disabled',
            'Item Name': item.get('name', ''),
            'Item Key': item.get('key_', ''),
            'Item Status': 'Enabled' if item.get('status') == '0' else 'Disabled',
            'Group Name': group.get('name', '')
        })

# Create DataFrame and export to Excel
df = pd.DataFrame(data)
df.to_excel('zabbix_system_run_items.xlsx', index=False)

print("Excel file 'zabbix_system_run_items.xlsx' has been created successfully.")
