from pyzabbix import ZabbixAPI
import openpyxl

# Zabbix credentials
ZABBIX_URL = 'https://your_zabbix_url'
USERNAME = 'your_username'
PASSWORD = 'your_password'

# Connect to Zabbix API
zapi = ZabbixAPI(ZABBIX_URL)
zapi.login(USERNAME, PASSWORD)
print("Connected to Zabbix API")

# Prepare Excel workbook
workbook = openpyxl.Workbook()
sheet = workbook.active
sheet.title = 'Host Macros'
sheet.append(['Host Name', 'Macro Name', 'Macro Value'])

# Get all hosts
hosts = zapi.host.get(output=['hostid', 'host'])

# Loop through hosts to get macros
for host in hosts:
    macros = zapi.usermacro.get(
        hostids=host['hostid'],
        output=['macro', 'value']
    )
    for macro in macros:
        sheet.append([host['host'], macro['macro'], macro['value']])

# Save Excel file
excel_file = 'zabbix_host_macros.xlsx'
workbook.save(excel_file)
print(f"Data saved to {excel_file}")
