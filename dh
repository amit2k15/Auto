from pyzabbix import ZabbixAPI
import openpyxl

# Zabbix API credentials
ZABBIX_SERVER = 'http://your_zabbix_server_url/zabbix'
ZABBIX_USER = 'your_username'
ZABBIX_PASSWORD = 'your_password'

# Initialize Zabbix API
zapi = ZabbixAPI(ZABBIX_SERVER)
zapi.login(ZABBIX_USER, ZABBIX_PASSWORD)

# Fetch disabled hosts
disabled_hosts = zapi.host.get(
    output=['hostid', 'host', 'name'],
    filter={'status': '1'}  # 1 indicates disabled hosts
)

# Prepare data for Excel
data = []
for host in disabled_hosts:
    host_id = host['hostid']
    host_name = host['host']
    host_display_name = host['name']

    # Fetch host groups for the host
    host_groups = zapi.hostgroup.get(
        output=['name'],
        hostids=host_id
    )
    host_group_names = ', '.join([group['name'] for group in host_groups])

    # Fetch tags for the host
    tags = zapi.host.get(
        output=['tags'],
        hostids=host_id,
        selectTags='extend'
    )[0].get('tags', [])

    # Find the APP tag value
    app_tag_value = ''
    for tag in tags:
        if tag['tag'] == 'APP':
            app_tag_value = tag['value']
            break

    # Append the data
    data.append([host_name, host_display_name, host_group_names, app_tag_value])

# Create an Excel workbook and worksheet
wb = openpyxl.Workbook()
ws = wb.active
ws.title = "Disabled Hosts"

# Add headers
ws.append(['Host Name', 'Display Name', 'Host Groups', 'APP Tag Value'])

# Add data rows
for row in data:
    ws.append(row)

# Save the workbook
excel_filename = 'disabled_hosts.xlsx'
wb.save(excel_filename)

print(f"Data exported to {excel_filename}")

# Logout from Zabbix API
zapi.user.logout()
